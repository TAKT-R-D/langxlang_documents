---
filePath: source/next.js/docs/02-app/01-building-your-application/09-authentication/index.mdx
title: Authentication
description: Learn how to implement authentication in Next.js, covering best practices, securing routes, authorization techniques, and session management.
org_title: Authentication
org_path: /docs/app/building-your-application/authentication
is_empty: false
---

Next.js ã®èªè¨¼ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ä¸‰ã¤ã®åŸºæœ¬æ¦‚å¿µã‚’ç†è§£ã—ã¦ãã ã•ã„ï¼š

- [**èªè¨¼**](#authentication)ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ãŒä¸»å¼µã™ã‚‹é€šã‚Šã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã‚ˆã†ãªã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã£ã¦ã„ã‚‹ä½•ã‹ã§è‡ªèº«ã®èº«å…ƒã‚’è¨¼æ˜ã™ã‚‹ã“ã¨ã‚’è¦æ±‚ã—ã¾ã™ã€‚
- [**ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**](#session-management)ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹(ä¾‹ï¼šãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹)ã‚’è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ãŸã£ã¦è¿½è·¡ã—ã¾ã™ã€‚
- [**Authorization**](#authorization)ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã©ã®éƒ¨åˆ†ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚’æ±ºå®šã—ã¾ã™ã€‚

ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€Next.js ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ä¸€èˆ¬çš„ãªèªè¨¼ã€æ‰¿èªã€ãŠã‚ˆã³ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‹ãƒ¼ã‚ºã«åŸºã¥ã„ã¦æœ€é©ãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠã§ãã¾ã™ã€‚

## Authentication

èªè¨¼ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èº«å…ƒã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã‚Œã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ path ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã‹ã€Google ã®ã‚ˆã†ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’é€šã˜ã¦è¡Œã‚ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ¬å½“ã«è‡ªåˆ†ãŒä¸»å¼µã™ã‚‹äººç‰©ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã«é–¢é€£ã—ã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚„è©æ¬ºçš„ãªè¡Œç‚ºã‹ã‚‰ä¿è­·ã—ã¾ã™ã€‚

### èªè¨¼æˆ¦ç•¥

ç¾ä»£ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ä¸€èˆ¬çš„ã«ã„ãã¤ã‹ã®èªè¨¼æˆ¦ç•¥ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

1. **OAuth/OpenID Connect (OIDC)**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’å…±æœ‰ã›ãšã«ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚„ã‚·ãƒ³ã‚°ãƒ«ã‚µã‚¤ãƒ³ã‚ªãƒ³(SSO)ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«ç†æƒ³çš„ã§ã™ã€‚OpenID Connect ã‚’ç”¨ã„ã¦ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£å±¤ã‚’è¿½åŠ ã—ã¾ã™ã€‚
2. **ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ­ã‚°ã‚¤ãƒ³(Email + Password)**: Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¨™æº–çš„ãªé¸æŠè‚¢ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ email ã¨ password ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚ä½¿ã„æ…£ã‚Œã¦ãŠã‚Šã€å®Ÿè£…ã‚‚å®¹æ˜“ã§ã™ãŒã€ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã®ã‚ˆã†ãªè„…å¨ã«å¯¾ã™ã‚‹å …ç‰¢ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãŒå¿…è¦ã§ã™ã€‚
3. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹/ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹ã®èªè¨¼**ï¼šå®‰å…¨ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã«ã€ãƒ¡ãƒ¼ãƒ«ãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯ã¾ãŸã¯ SMS ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãã®ä¾¿åˆ©ã•ã¨å¼·åŒ–ã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã§äººæ°—ã§ã‚ã‚Šã€ã“ã® method ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç–²åŠ´ã‚’è»½æ¸›ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚ãã®åˆ¶ç´„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã¾ãŸã¯é›»è©±ã®åˆ©ç”¨å¯èƒ½æ€§ã«ä¾å­˜ã—ã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚
4. **Passkeys/WebAuthn**: å„ã‚µã‚¤ãƒˆã«å›ºæœ‰ã®æš—å·åŒ–ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã€ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã«å¯¾ã™ã‚‹é«˜ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æä¾›ã—ã¾ã™ã€‚å®‰å…¨ã§ã™ãŒæ–°ã—ã„ãŸã‚ã€ã“ã® strategy ã¯å®Ÿè£…ãŒé›£ã—ã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

authentication strategy ã®é¸æŠã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç‰¹å®šã®è¦ä»¶ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®è€ƒæ…®äº‹é …ã€ãŠã‚ˆã³ security objectives ã¨ä¸€è‡´ã™ã‚‹ã¹ãã§ã™ã€‚

### èªè¨¼ã®å®Ÿè£…

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€åŸºæœ¬çš„ãªãƒ¡ãƒ¼ãƒ« path ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¿½åŠ ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ¢æ±‚ã—ã¾ã™ã€‚ã“ã® method ã¯åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã‚’æä¾›ã—ã¾ã™ãŒã€ä¸€èˆ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨ã«å¯¾ã™ã‚‹å¼·åŒ–ä¿è­·ã®ãŸã‚ã«ã€OAuth ã‚„ path ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãƒ­ã‚°ã‚¤ãƒ³ãªã©ã®ã‚ˆã‚Šé«˜åº¦ãª options ã‚’æ¤œè¨ã™ã‚‹ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã€‚ç§ãŸã¡ãŒè­°è«–ã™ã‚‹èªè¨¼ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

<PagesOnly>

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€šã˜ã¦è‡ªèº«ã® credentials ã‚’æå‡ºã—ã¾ã™ã€‚
2. ã“ã®ãƒ•ã‚©ãƒ¼ãƒ ã¯ã€API route ãŒå‡¦ç†ã™ã‚‹ request ã‚’é€ä¿¡ã—ã¾ã™ã€‚
3. æ­£å¸¸ã«ç¢ºèªãŒå®Œäº†ã—ãŸå ´åˆã€ãƒ—ãƒ­ã‚»ã‚¹ã¯å®Œäº†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ­£å¸¸ãªèªè¨¼ãŒç¤ºã•ã‚Œã¾ã™ã€‚
4. æ¤œè¨¼ãŒå¤±æ•—ã—ãŸå ´åˆã€error message ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªèº«ã®èªè¨¼æƒ…å ±ã‚’å…¥åŠ›ã§ãã‚‹ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†:

```tsx:pages/login.tsx
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // Handle errors
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  )
}
```

```jsx:pages/login.jsx
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // Handle errors
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  )
}
```

ä¸Šè¨˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ path ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ãŸã‚ã® 2 ã¤ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚é€ä¿¡ã™ã‚‹ã¨ã€POST request ã‚’ API route (`/api/auth/login`) ã«é€ä¿¡ã™ã‚‹æ©Ÿèƒ½ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™ã€‚

ãã®å¾Œã€èªè¨¼ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã® API ã‚’ API route ã§å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts:pages/api/auth/login.ts
import { NextApiRequest, NextApiResponse } from 'next'
import { signIn } from '@/auth'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'Invalid credentials.' })
    } else {
      res.status(500).json({ error: 'Something went wrong.' })
    }
  }
}
```

```js:pages/api/auth/login.js
import { signIn } from '@/auth'

export default async function handler(req, res) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'Invalid credentials.' })
    } else {
      res.status(500).json({ error: 'Something went wrong.' })
    }
  }
}
```

</PagesOnly>

<AppOnly>

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€šã˜ã¦è‡ªèº«ã® credentials ã‚’æå‡ºã—ã¾ã™ã€‚
2. ãã®ãƒ•ã‚©ãƒ¼ãƒ ã¯ Server Action ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
3. æ­£å¸¸ã«ç¢ºèªãŒå®Œäº†ã—ãŸå ´åˆã€ãƒ—ãƒ­ã‚»ã‚¹ã¯å®Œäº†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ­£å¸¸ãªèªè¨¼ãŒç¤ºã•ã‚Œã¾ã™ã€‚
4. æ¤œè¨¼ãŒå¤±æ•—ã—ãŸå ´åˆã€error message ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªèº«ã®èªè¨¼æƒ…å ±ã‚’å…¥åŠ›ã§ãã‚‹ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†:

```tsx:app/login/page.tsx
import { authenticate } from '@/app/lib/actions'

export default function Page() {
  return (
    <form action={authenticate}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  )
}
```

```jsx:app/login/page.jsx
import { authenticate } from '@/app/lib/actions'

export default function Page() {
  return (
    <form action={authenticate}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  )
}
```

ä¸Šè¨˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ path ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ãŸã‚ã® 2 ã¤ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚é€ä¿¡æ™‚ã«ã¯ã€`authenticate` Server Action ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

ãã®å¾Œã€ã‚ãªãŸã¯èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ã® API ã‚’ Server Action ã§å‘¼ã³å‡ºã—ã¦èªè¨¼ã‚’å‡¦ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

```ts:app/lib/actions.ts
'use server'

import { signIn } from '@/auth'

export async function authenticate(_currentState: unknown, formData: FormData) {
  try {
    await signIn('credentials', formData)
  } catch (error) {
    if (error) {
      switch (error.type) {
        case 'CredentialsSignin':
          return 'Invalid credentials.'
        default:
          return 'Something went wrong.'
      }
    }
    throw error
  }
}
```

```js:app/lib/actions.js
'use server'

import { signIn } from '@/auth'

export async function authenticate(_currentState, formData) {
  try {
    await signIn('credentials', formData)
  } catch (error) {
    if (error) {
      switch (error.type) {
        case 'CredentialsSignin':
          return 'Invalid credentials.'
        default:
          return 'Something went wrong.'
      }
    }
    throw error
  }
}
```

</AppOnly>

ã“ã® code ã§ã¯ã€`signIn` method ãŒæ ¼ç´ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨ã®ç…§åˆã‚’è¡Œã„ã¾ã™ã€‚èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒè³‡æ ¼æƒ…å ±ã‚’å‡¦ç†ã—ãŸå¾Œã€2 ã¤ã®å¯èƒ½ãªçµæœãŒã‚ã‚Šã¾ã™ï¼š

- **èªè¨¼æˆåŠŸ**ï¼šã“ã®çµæœã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ãŒæˆåŠŸã—ãŸã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä¿è­·ã•ã‚ŒãŸ routes ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ãªã©ã®ã•ã‚‰ãªã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã§ãã¾ã™ã€‚
- **èªè¨¼å¤±æ•—**ï¼šè³‡æ ¼æƒ…å ±ãŒé–“é•ã£ã¦ã„ã‚‹å ´åˆã‚„ error ãŒç™ºç”Ÿã—ãŸå ´åˆã€èªè¨¼ãŒå¤±æ•—ã—ãŸã“ã¨ã‚’ç¤ºã™ error message ã‚’é–¢æ•°ãŒè¿”ã—ã¾ã™ã€‚

<AppOnly>

æœ€å¾Œã«ã€`login-form.tsx`ã® component ã§ã€React ã®`useFormState`ã‚’ä½¿ã£ã¦ Server Action ã‚’å‘¼ã³å‡ºã—ã€ãƒ•ã‚©ãƒ¼ãƒ  error ã‚’å‡¦ç†ã—ã€`useFormStatus`ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã®ä¿ç•™ä¸­ã®çŠ¶æ…‹ã‚’å‡¦ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

```tsx:app/login/page.tsx
'use client'

import { authenticate } from '@/app/lib/actions'
import { useFormState, useFormStatus } from 'react-dom'

export default function Page() {
  const [errorMessage, dispatch] = useFormState(authenticate, undefined)

  return (
    <form action={dispatch}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <div>{errorMessage && <p>{errorMessage}</p>}</div>
      <LoginButton />
    </form>
  )
}

function LoginButton() {
  const { pending } = useFormStatus()

  return (
    <button aria-disabled={pending} type="submit">
      Login
    </button>
  )
}
```

```jsx:app/login/page.jsx
'use client'

import { authenticate } from '@/app/lib/actions'
import { useFormState, useFormStatus } from 'react-dom'

export default function Page() {
  const [errorMessage, dispatch] = useFormState(authenticate, undefined)

  return (
    <form action={dispatch}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <div>{errorMessage && <p>{errorMessage}</p>}</div>
      <LoginButton />
    </form>
  )
}

function LoginButton() {
  const { pending } = useFormStatus()

  return (
    <button aria-disabled={pending} type="submit">
      Login
    </button>
  )
}
```

</AppOnly>

Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã€ç‰¹ã«è¤‡æ•°ã®ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã‚’æä¾›ã™ã‚‹å ´åˆã«ã€ã‚ˆã‚Šã‚¹ãƒ ãƒ¼ã‚ºãªèªè¨¼è¨­å®šã‚’è¡Œã†ãŸã‚ã«ã¯ã€åŒ…æ‹¬çš„ãª[èªè¨¼ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³](#examples)ã®ä½¿ç”¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

## Authorization

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç‰¹å®šã® routes ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã—ã¦ã€Server Actions ã§ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰ç•°ã•ã›ãŸã‚Šã€Route Handlers ã‚’å‘¼ã³å‡ºã™ãªã©ã®æ“ä½œã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

### Middleware ã‚’ä½¿ç”¨ã—ã¦ Routes ã‚’ä¿è­·ã™ã‚‹

Next.js ã®[Middleware](/ja/javascript/next.js/v14/02-app/01-building-your-application/01-routing/13-middleware)ã‚’ä½¿ã†ã¨ã€ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ã•ã¾ã–ã¾ãªéƒ¨åˆ†ã«èª°ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ã‚½ãƒ¼ãƒ« dashboard ã®ã‚ˆã†ãªã‚¨ãƒªã‚¢ã‚’ä¿è­·ã—ãªãŒã‚‰ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ãªã©ã®ä»–ã®ãƒšãƒ¼ã‚¸ã‚’ public ã«ã™ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚ Middleware ã¯ã€ã™ã¹ã¦ã® routes ã«é©ç”¨ã—ã€ public ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é™¤å¤–ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã«ã€Next.js ã§èªè¨¼ã®ãŸã‚ã® Middleware ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¾ã™ï¼š

1. **Middleware ã®è¨­å®š:**
   - ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® root ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`middleware.ts`ã¾ãŸã¯`.js`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‰¿èªã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã‚ã¦ãã ã•ã„ã€‚ãŸã¨ãˆã°ã€authentication tokens ã®ãƒã‚§ãƒƒã‚¯ãªã©ã§ã™ã€‚
2. **ä¿è­·ã•ã‚ŒãŸ Routes ã®å®šç¾©ï¼š**

- ã™ã¹ã¦ã® routes require ã«èªè¨¼ãŒå¿…è¦ãªã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ãªãŸã® Middleware ã§`matcher`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€èªè¨¼ãƒã‚§ãƒƒã‚¯ãŒ require ã•ã‚Œãªã„ä»»æ„ã® routes ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚

3. **Middleware ãƒ­ã‚¸ãƒƒã‚¯ï¼š**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ãã€‚ route ã®èªå¯ã®ãŸã‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ã‚„æ¨©é™ã‚’ç¢ºèªã—ã¾ã™ã€‚
4. **ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã®å¯¾å¿œ:**
   - ä¸æ­£ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é©åˆ‡ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¾ãŸã¯ error page ã¸ Redirect ã—ã¦ãã ã•ã„ã€‚

ä¾‹ãˆã° Middleware ãƒ•ã‚¡ã‚¤ãƒ«:

```ts:middleware.ts
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const currentUser = request.cookies.get('currentUser')?.value

  if (currentUser) {
    return NextResponse.redirect(new URL('/dashboard', request.url))
  }
  return NextResponse.redirect(new URL('/login', request.url))
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

```js:middleware.js
import { NextResponse } from 'next/server'

export function middleware(request) {
  const currentUser = request.cookies.get('currentUser')?.value

  if (currentUser) {
    return NextResponse.redirect(new URL('/dashboard', request.url))
  }
  return NextResponse.redirect(new URL('/login', request.url))
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

ã“ã®ä¾‹ã§ã¯ã€[`NextResponse.redirect`](/ja/javascript/next.js/v14/02-app/02-api-reference/04-functions/next-response#redirect)ã‚’ä½¿ç”¨ã—ã¦ã€ request ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®åˆæœŸæ®µéšã§ redirects ã‚’å‡¦ç†ã—ã€ãã‚Œã‚’åŠ¹ç‡çš„ã«è¡Œã„ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’é›†ä¸­åŒ–ã—ã¾ã™ã€‚

<AppOnly>

å…·ä½“çš„ãªãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®ãƒ‹ãƒ¼ã‚ºã«å¯¾ã—ã¦ã€`redirect`é–¢æ•°ã¯ Server Components ã€ Route ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã€ãŠã‚ˆã³ Server Actions ã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã€ã‚ˆã‚Šå¤šãã®åˆ¶å¾¡ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚„æ–‡è„ˆã«å¿œã˜ãŸã‚·ãƒŠãƒªã‚ªã«å½¹ç«‹ã¡ã¾ã™ã€‚

```ts:app/page.tsx
import { redirect } from 'next/navigation'

export default function Page() {
  // Logic to determine if a redirect is needed
  const accessDenied = true
  if (accessDenied) {
    redirect('/login')
  }

  // Define other routes and logic
}
```

```js:app/page.jsx
import { redirect } from 'next/navigation'

export default function Page() {
  // Logic to determine if a redirect is needed
  const accessDenied = true
  if (accessDenied) {
    redirect('/login')
  }

  // Define other routes and logic
}
```

</AppOnly>

æˆåŠŸã—ãŸèªè¨¼ã®å¾Œã€ãã‚Œãã‚Œã®å½¹å‰²ã«åŸºã¥ã„ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ä¾‹ãˆã°ã€ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ dashboard ã¨ã„ã†ç®¡ç†è€…ç”¨ã®ãƒšãƒ¼ã‚¸ã« Redirect ã•ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€ä¸€æ–¹ã§ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯åˆ¥ã®ãƒšãƒ¼ã‚¸ã«é€ã‚‰ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€å½¹å‰²ã«ç‰¹åŒ–ã—ãŸçµŒé¨“ã¨æ¡ä»¶ä»˜ããƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã€ä¾‹ãˆã°å¿…è¦ãªã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å®Œæˆã•ã›ã‚‹ã‚ˆã†ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¿ƒã™ã“ã¨ãªã©ã«é‡è¦ã§ã™ã€‚

èªè¨¼ã‚’è¨­å®šã™ã‚‹éš›ã«ã¯ã€ã‚ãªãŸã® app ãŒãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹å ´æ‰€ã§ä¸»è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚Middleware ã¯åˆæœŸã®æ¤œè¨¼ã«ã¯å½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®å”¯ä¸€ã®é˜²è¡›ç·šã«ã¯ã™ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã®å¤§éƒ¨åˆ†ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼(DAL)ã§è¡Œã†ã¹ãã§ã™ã€‚

<PagesOnly>

### API Routes ã‚’ä¿è­·ã™ã‚‹

API Routes ã¯ã€Next.js ã«ãŠã‘ã‚‹ server-side ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«ä¸å¯æ¬ ã§ã™ã€‚ã“ã‚Œã‚‰ã® routes ã‚’ä¿è­·ã™ã‚‹ã“ã¨ã¯å¿…è¦ä¸å¯æ¬ ã§ã€ç‰¹å®šã®æ©Ÿèƒ½ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’èªè¨¼æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«åˆ¶é™ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ã“ã‚Œã«ã¯é€šå¸¸ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨å½¼ã‚‰ã®ãƒ­ãƒ¼ãƒ«ã«åŸºã¥ãæ¨©é™ã®ç¢ºèªãŒå«ã¾ã‚Œã¾ã™ã€‚

ã“ã‚Œã¯ API Route ã‚’ä¿è­·ã™ã‚‹ä¾‹ã§ã™ï¼š

```ts:pages/api/route.ts
import { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const session = await getSession(req)

  // Check if the user is authenticated
  if (!session) {
    res.status(401).json({
      error: 'User is not authenticated',
    })
    return
  }

  // Check if the user has the 'admin' role
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'Unauthorized access: User does not have admin privileges.',
    })
    return
  }

  // Proceed with the route for authorized users
  // ... implementation of the API Route
}
```

```js:pages/api/route.js
export default async function handler(req, res) {
  const session = await getSession(req)

  // Check if the user is authenticated
  if (!session) {
    res.status(401).json({
      error: 'User is not authenticated',
    })
    return
  }

  // Check if the user has the 'admin' role
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'Unauthorized access: User does not have admin privileges.',
    })
    return
  }

  // Proceed with the route for authorized users
  // ... implementation of the API Route
}
```

ã“ã®ä¾‹ã¯ã€èªè¨¼ã¨è¨±å¯ã®ãŸã‚ã® 2 æ®µéšã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å‚™ãˆãŸ API Route ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã¾ãšã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã—ã€æ¬¡ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ'admin'ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€èªè¨¼ã•ã‚Œã€è¨±å¯ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é™å®šã—ãŸã‚»ã‚­ãƒ¥ã‚¢ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¢ºä¿ã—ã€request ã®å‡¦ç†ã«å¯¾ã™ã‚‹å …ç‰¢ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¶­æŒã—ã¾ã™ã€‚

</PagesOnly>

<AppOnly>

ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€[ã“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ–ãƒ­ã‚°](/blog/security-nextjs-server-components-actions)ã§å¼·èª¿ã•ã‚Œã¦ãŠã‚Šã€å°‚ç”¨ã® DAL å†…ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’é›†ç´„ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚ã“ã® strategy ã¯ã€ä¸€è²«ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¿è¨¼ã—ã€èªè¨¼ã®ãƒã‚°ã‚’æœ€å°é™ã«æŠ‘ãˆã€ä¿å®ˆã‚’ç°¡ç´ åŒ–ã—ã¾ã™ã€‚åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®é‡è¦ãªé ˜åŸŸã‚’è€ƒæ…®ã—ã¦ãã ã•ã„:

- Server Actions : server-side ã®ãƒ—ãƒ­ã‚»ã‚¹ã€ç‰¹ã«æ©Ÿå¯†æ€§ã®é«˜ã„æ“ä½œã«å¯¾ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
- Route ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’ç”¨ã„ã¦å—ä¿¡ Request ã‚’ç®¡ç†ã—ã€ã‚¢ã‚¯ã‚»ã‚¹ãŒèªè¨¼æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é™å®šã•ã‚Œã‚‹ã‚ˆã†ç¢ºä¿ã—ã¾ã™ã€‚
- ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ (DAL)ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ç›´æ¥å¯¾è©±ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®æ¤œè¨¼ã¨æ‰¿èªã«ã¯ä¸å¯æ¬ ã§ã™ã€‚æœ€ã‚‚é‡è¦ãªå¯¾è©±ãƒã‚¤ãƒ³ãƒˆã€ã™ãªã‚ã¡ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚„å¤‰æ›´ã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã€DAL å†…ã§ã®é‡è¦ãªãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã“ã¨ãŒæ¥µã‚ã¦é‡è¦ã§ã™ã€‚

DAL ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®è©³ç´°ãªã‚¬ã‚¤ãƒ‰ã€ä¾‹ãˆã° code ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚„é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã«ã¤ã„ã¦ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ã®[Data Access Layer ã‚»ã‚¯ã‚·ãƒ§ãƒ³](/blog/security-nextjs-server-components-actions#data-access-layer)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Server Actions ã®ä¿è­·

[Server Actions](/ja/javascript/next.js/v14/02-app/01-building-your-application/02-data-fetching/02-server-actions-and-mutations)ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ•ã‚§ã‚¤ã‚¹ã® API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨åŒç­‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã§æ‰±ã†ã“ã¨ãŒé‡è¦ã§ã™ã€‚å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªå¯ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ Server Actions å†…éƒ¨ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’ç¢ºèªã™ã‚‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ç‰¹å®šã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«åˆ¶é™ã™ã‚‹ãªã©ã§ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€²ã‚ã‚‹å‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® role ã‚’ç¢ºèªã—ã¾ã™ï¼š

```ts:app/lib/actions.ts
'use server'

// ...

export async function serverAction() {
  const session = await getSession()
  const userRole = session?.user?.role

  // Check if user is authorized to perform the action
  if (userRole !== 'admin') {
    throw new Error('Unauthorized access: User does not have admin privileges.')
  }

  // Proceed with the action for authorized users
  // ... implementation of the action
}
```

```js:app/lib/actions.js
'use server'

// ...

export async function serverAction() {
  const session = await getSession()
  const userRole = session?.user?.role

  // Check if user is authorized to perform the action
  if (userRole !== 'admin') {
    throw new Error('Unauthorized access: User does not have admin privileges.')
  }

  // Proceed with the action for authorized users
  // ... implementation of the action
}
```

### Route ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä¿è­·ã™ã‚‹

Next.js ã® Route ãƒãƒ³ãƒ‰ãƒ©ã¯ã€å—ä¿¡ Request ã®ç®¡ç†ã«ãŠã„ã¦é‡è¦ãªå½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚Server Actions ã¨åŒæ§˜ã«ã€ç‰¹å®šã®æ©Ÿèƒ½ã«å¯¾ã—ã¦ã®ã¿èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã€ãã‚Œã‚‰ã¯ä¿å…¨ã•ã‚Œã‚‹ã¹ãã§ã™ã€‚ã“ã†ã„ã£ãŸã“ã¨ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨å½¼ã‚‰ã®æ¨©é™ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚’ã—ã°ã—ã°å«ã¿ã¾ã™ã€‚

ã“ã“ã« Route Handler ã‚’ç¢ºä¿ã™ã‚‹ä¾‹ãŒã‚ã‚Šã¾ã™ï¼š

```ts:app/api/route.ts
export async function GET() {
  // User authentication and role verification
  const session = await getSession()

  // Check if the user is authenticated
  if (!session) {
    return new Response(null, { status: 401 }) // User is not authenticated
  }

  // Check if the user has the 'admin' role
  if (session.user.role !== 'admin') {
    return new Response(null, { status: 403 }) // User is authenticated but does not have the right permissions
  }

  // Data fetching for authorized users
}
```

```js:app/api/route.js
export async function GET() {
  // User authentication and role verification
  const session = await getSession()

  // Check if the user is authenticated
  if (!session) {
    return new Response(null, { status: 401 }) // User is not authenticated
  }

  // Check if the user has the 'admin' role
  if (session.user.role !== 'admin') {
    return new Response(null, { status: 403 }) // User is authenticated but does not have the right permissions
  }

  // Data fetching for authorized users
}
```

ã“ã®ä¾‹ã§ã¯ã€èªè¨¼ã¨èªå¯ã®ãŸã‚ã®äºŒå±¤ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å‚™ãˆãŸ Route Handler ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã¾ãšã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã€æ¬¡ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ'admin'ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€èªè¨¼ã•ã‚Œã€èªå¯ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã¸ã®ã‚»ã‚­ãƒ¥ã‚¢ãªã‚¢ã‚¯ã‚»ã‚¹ãŒä¿è¨¼ã•ã‚Œã€request ã®å‡¦ç†ã«å¯¾ã—ã¦å …ç‰¢ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒç¶­æŒã•ã‚Œã¾ã™ã€‚

### Server Components ã‚’ä½¿ç”¨ã—ãŸæ‰¿èª

Next.js ã®[Server Components](/ja/javascript/next.js/v14/02-app/01-building-your-application/03-rendering/01-server-components)ã¯ã€èªè¨¼ã®ã‚ˆã†ãªè¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±åˆã™ã‚‹ãŸã‚ã®å®‰å…¨ãªç’°å¢ƒã‚’æä¾›ã™ã‚‹ãŸã‚ã«ã€server-side å®Ÿè¡Œã®ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãã‚Œã‚‰ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¯èƒ½ã«ã—ã€ãƒ‡ãƒ¼ã‚¿é‡è¦–ã®ã‚¿ã‚¹ã‚¯ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã—ã€ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªæ“ä½œã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã—ã¾ã™ã€‚

Server Components ã§ã¯ã€ã‚ˆãè¡Œã‚ã‚Œã‚‹å®Ÿè·µã¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã«åŸºã¥ã„ã¦ UI è¦ç´ ã‚’æ¡ä»¶ä»˜ãã§ render ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–²è¦§ã‚’è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’é«˜ã‚ã¾ã™ã€‚

**Example:**

```tsx:app/dashboard/page.tsx
export default function Dashboard() {
  const session = await getSession()
  const userRole = session?.user?.role // Assuming 'role' is part of the session object

  if (userRole === 'admin') {
    return <AdminDashboard /> // Component for admin users
  } else if (userRole === 'user') {
    return <UserDashboard /> // Component for regular users
  } else {
    return <AccessDenied /> // Component shown for unauthorized access
  }
}
```

```jsx:app/dashboard/page.jsx
export default function Dashboard() {
  const session = await getSession()
  const userRole = session?.user?.role // Assuming 'role' is part of the session object

  if (userRole === 'admin') {
    return <AdminDashboard /> // Component for admin users
  } else if (userRole === 'user') {
    return <UserDashboard /> // Component for regular users
  } else {
    return <AccessDenied /> // Component shown for unauthorized access
  }
}
```

ã“ã®ä¾‹ã§ã¯ã€Dashboard component ã¯'admin'ã€'user'ã€ãã—ã¦æœªæ‰¿èªã®å½¹å‰²ã«å¯¾ã—ã¦ç•°ãªã‚‹ UI ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®å½¹å‰²ã«é©ã—ãŸ Component ã®ã¿ã¨å¯¾è©±ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã®ä¸¡æ–¹ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚

</AppOnly>

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- **ã‚»ã‚­ãƒ¥ã‚¢ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æœ€å„ªå…ˆã—ã€ä¸æ­£ãªã‚¢ã‚¯ã‚»ã‚¹ã‚„ãƒ‡ãƒ¼ã‚¿ä¾µå®³ã‚’é˜²ãã¾ã™ã€‚æš—å·åŒ–ã¨ã‚»ã‚­ãƒ¥ã‚¢ãªä¿å­˜ã®æ‰‹æ³•ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
- **Dynamic ãƒ­ãƒ¼ãƒ«ç®¡ç†**ï¼š æŸ”è»Ÿãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ã€æ¨©é™ã¨ãƒ­ãƒ¼ãƒ«ã®å¤‰æ›´ã«å®¹æ˜“ã«å¯¾å¿œã—ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã‚’é¿ã‘ã¾ã™ã€‚
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æœ€å„ªå…ˆã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**ï¼š èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®ã™ã¹ã¦ã®å´é¢ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Œå…¨æ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã¯ã€å¾¹åº•çš„ãªãƒ†ã‚¹ãƒˆã¨æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è„†å¼±æ€§ã‚’è€ƒæ…®ã™ã‚‹ã“ã¨ãŒå«ã¾ã‚Œã¾ã™ã€‚

## Session Management

ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã®ã‚„ã‚Šå–ã‚Šã‚’æ™‚é–“ã‚’é€šã˜ã¦è¿½è·¡ã—ã€ç®¡ç†ã™ã‚‹ã“ã¨ã‚’å«ã¿ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€èªè¨¼ã•ã‚ŒãŸçŠ¶æ…‹ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç•°ãªã‚‹éƒ¨åˆ†ã§ä¿æŒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ç¹°ã‚Šè¿”ã—ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒä¸è¦ã«ãªã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ©ä¾¿æ€§ãŒã¨ã‚‚ã«å‘ä¸Šã—ã¾ã™ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã«ä½¿ç”¨ã•ã‚Œã‚‹ä¸»ãªæ–¹æ³•ã¯ 2 ã¤ã‚ã‚Šã¾ã™ï¼š cookie-based ã¨ database sessions ã§ã™ã€‚

### Cookie ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³

> **ğŸ¥ è¦–è´:** Next.js ã§ã®ã‚¯ãƒƒã‚­ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨èªè¨¼ã«ã¤ã„ã¦è©³ã—ãå­¦ã³ã¾ã—ã‚‡ã† â†’ [YouTube (11 åˆ†)](https://www.youtube.com/watch?v=DJvM2lSPn6w)ã€‚

Cookie ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã® cookies ã«ç›´æ¥æš—å·åŒ–ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ ¼ç´ã™ã‚‹ã“ã¨ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€ã“ã®æš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ cookie ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚ãã®å¾Œã®ã™ã¹ã¦ã® server request ã«ã¯ã“ã® cookie ãŒå«ã¾ã‚Œã€ç¹°ã‚Šè¿”ã—ã® server ã‚¯ã‚¨ãƒªã®å¿…è¦æ€§ã‚’æœ€å°é™ã«æŠ‘ãˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®åŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚

ã—ã‹ã—ã€ã“ã® method ã¯ã€æ•æ„Ÿãªãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«æ…é‡ãªæš—å·åŒ–ãŒå¿…è¦ã§ã™ã€‚ãªãœãªã‚‰ã€cookies ã¯ Client å´ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã«å¯¾ã—ã¦è„†å¼±ã ã‹ã‚‰ã§ã™ã€‚cookies å†…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã™ã‚‹ã“ã¨ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚‰å®ˆã‚‹ãŸã‚ã®é‡è¦ãªæ–¹æ³•ã§ã™ã€‚ãã‚Œã«ã‚ˆã‚Šã€cookie ãŒç›—ã¾ã‚ŒãŸã¨ã—ã¦ã‚‚ã€ãã®å†…éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯èª­ã¿å–ã‚Œãªã„çŠ¶æ…‹ã‚’ä¿ã¤ã“ã¨ãŒã§ãã¾ã™ã€‚

ã•ã‚‰ã«ã€å€‹ã€…ã® cookies ã¯ size (é€šå¸¸ç´„ 4KB)ã«åˆ¶é™ãŒã‚ã‚Šã¾ã™ãŒã€cookie-chunking ã®ã‚ˆã†ãªæŠ€è¡“ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å¤§ããªã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ã® cookies ã«åˆ†å‰²ã™ã‚‹ã“ã¨ã§ã“ã®åˆ¶é™ã‚’å…‹æœã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ cookie ã‚’è¨­å®šã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š

**server ã« cookie ã‚’è¨­å®šã™ã‚‹:**

<PagesOnly>

```ts:pages/api/login.ts
import { serialize } from 'cookie'
import type { NextApiRequest, NextApiResponse } from 'next'

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // One week
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'Successfully set cookie!' })
}
```

```js:pages/api/login.js
import { serialize } from 'cookie'

export default function handler(req, res) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // One week
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'Successfully set cookie!' })
}
```

</PagesOnly>

<AppOnly>

```ts:app/actions.ts
'use server'

import { cookies } from 'next/headers'

export async function handleLogin(sessionData) {
  const encryptedSessionData = encrypt(sessionData) // Encrypt your session data
  cookies().set('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // One week
    path: '/',
  })
  // Redirect or handle the response after setting the cookie
}
```

```js:app/actions.js
'use server'

import { cookies } from 'next/headers'

export async function handleLogin(sessionData) {
  const encryptedSessionData = encrypt(sessionData) // Encrypt your session data
  cookies().set('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // One week
    path: '/',
  })
  // Redirect or handle the response after setting the cookie
}
```

**server component ã§ cookie ã«ä¿å­˜ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ï¼š**

```tsx:app/page.tsx
import { cookies } from 'next/headers'

export async function getSessionData(req) {
  const encryptedSessionData = cookies().get('session')?.value
  return encryptedSessionData ? JSON.parse(decrypt(encryptedSessionData)) : null
}
```

```jsx:app/page.jsx
import { cookies } from 'next/headers'

export async function getSessionData(req) {
  const encryptedSessionData = cookies().get('session')?.value
  return encryptedSessionData ? JSON.parse(decrypt(encryptedSessionData)) : null
}
```

</AppOnly>

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ server ã«ä¿å­˜ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã®ã¿ã‚’å—ã‘å–ã‚‹ã“ã¨ã‚’å«ã¿ã¾ã™ã€‚ã“ã® ID ã¯ã€server-side ã«ä¿å­˜ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã—ã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿è‡ªä½“ã¯å«ã¿ã¾ã›ã‚“ã€‚ã“ã® method ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã—ã€æ•æ„Ÿãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ Client å´ã®ç’°å¢ƒã‹ã‚‰é ã–ã‘ã€Client å´ã®æ”»æ’ƒã¸ã®éœ²å‡ºã®ãƒªã‚¹ã‚¯ã‚’æ¸›ã‚‰ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã¾ãŸã€ã‚ˆã‚Šå¤§è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ‹ãƒ¼ã‚ºã«å¯¾å¿œã™ã‚‹ãŸã‚ã«ã€ã‚ˆã‚Šã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§ã™ã€‚

ã—ã‹ã—ã€ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã¯ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ãŒã‚ã‚Šã¾ã™ã€‚å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå¢—ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã®ã‚ˆã†ãªæˆ¦ç•¥ã¯ã“ã‚Œã‚’ç·©å’Œã™ã‚‹ã®ã«å½¹ç«‹ã¤ã“ã¨ãŒã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¾å­˜ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨å¯ç”¨æ€§ã¨åŒã˜ãã‚‰ã„ä¿¡é ¼ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ã“ã“ã«ã¯ã€Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ç°¡æ˜“çš„ãªä¾‹ã‚’ç¤ºã—ã¾ã™ï¼š

** Server ä¸Šã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆ**:

<PagesOnly>

```ts:pages/api/create-session.ts
import db from '../../lib/db'
import { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'Internal Server Error' })
  }
}
```

```js:pages/api/create-session.js
import db from '../../lib/db'

export default async function handler(req, res) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'Internal Server Error' })
  }
}
```

</PagesOnly>

<AppOnly>

```js
import db from "./lib/db";

export async function createSession(user) {
  const sessionId = generateSessionId(); // Generate a unique session ID
  await db.insertSession({ sessionId, userId: user.id, createdAt: new Date() });
  return sessionId;
}
```

**Middleware ã¾ãŸã¯ Server-Side ãƒ­ã‚¸ãƒƒã‚¯ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹**:

```js
import { cookies } from "next/headers";
import db from "./lib/db";

export async function getSession() {
  const sessionId = cookies().get("sessionId")?.value;
  return sessionId ? await db.findSession(sessionId) : null;
}
```

</AppOnly>

### Next.js ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’é¸æŠã™ã‚‹

Next.js ã§ Cookies ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã™ã‚‹ã“ã¨ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‹ãƒ¼ã‚ºã«ã‚ˆã‚‹ã¨ã“ã‚ãŒå¤§ãã„ã§ã™ã€‚ Cookies ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€ã‚ˆã‚Šå°ã•ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ server è² è·ãŒä½ã„ç’°å¢ƒã«é©ã—ã¦ãŠã‚Šã€ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒã‚„ã‚„åŠ£ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¸€æ–¹ã€ã‚ˆã‚Šè¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãŒå‘ä¸Šã—ã€å¤§è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ç†æƒ³çš„ã§ã™ã€‚

[èªè¨¼ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³](#examples) ã§ã‚ã‚‹ [NextAuth.js](https://authjs.dev/guides/upgrade-to-v5) ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€cookies ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒã‚ˆã‚ŠåŠ¹ç‡çš„ã«ãªã‚Šã¾ã™ã€‚ã“ã®è‡ªå‹•åŒ–ã¯ development ãƒ—ãƒ­ã‚»ã‚¹ã‚’å˜ç´”åŒ–ã—ã¾ã™ãŒã€é¸ã°ã‚ŒãŸã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½¿ç”¨ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† method ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ãã‚ŒãŒã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®è¦ä»¶ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã‚ãªãŸã®é¸æŠã«é–¢ã‚ã‚‰ãšã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æˆ¦ç•¥ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚strategy ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚»ã‚­ãƒ¥ã‚¢ã§ HTTP å°‚ç”¨ã® cookies ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«ã¯ä¸å¯æ¬ ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯ã€å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªå–ã‚Šæ‰±ã„ãŒå¿…é ˆã§ã™ã€‚ä¸¡æ–¹ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã€ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã®é˜²æ­¢ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ä¿¡é ¼æ€§ã®ç¶­æŒã®ãŸã‚ã«ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ã®è¨­å®šã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®å®Ÿè£…ãŒé‡è¦ã§ã™ã€‚

## Examples

ã“ã“ã«ã¯ã€Next.js ã¨äº’æ›æ€§ã®ã‚ã‚‹èªè¨¼ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã‚Œã‚‰ã‚’è¨­å®šã™ã‚‹æ–¹æ³•ã‚’å­¦ã¶ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„:

{/* TODO: Change link to authjs.dev when new documentation is ready */}

- [Auth0](https://auth0.com/docs/quickstart/webapp/nextjs/01-login)
- [Clerk](https://clerk.com/docs/quickstarts/nextjs)
- [Kinde](https://kinde.com/docs/developer-tools/nextjs-sdk)
- [Lucia](https://lucia-auth.com/getting-started/nextjs-app)
- [NextAuth.js](https://authjs.dev/guides/upgrade-to-v5)
- [Supabase](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs)
- [Stytch](https://stytch.com/docs/guides/quickstarts/nextjs)
- [Iron Session](https://github.com/vvo/iron-session)

## Further Reading

èªè¨¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦å­¦ç¿’ã‚’ç¶šã‘ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¦ãã ã•ã„ï¼š

- [XSS æ”»æ’ƒã‚’ç†è§£ã™ã‚‹](https://vercel.com/guides/understanding-xss-attacks)
- [CSRF æ”»æ’ƒã®ç†è§£](https://vercel.com/guides/understanding-csrf-attacks)
