---
filePath: source/next.js/docs/02-app/01-building-your-application/02-data-fetching/02-server-actions-and-mutations.mdx
title: Server Actions and Mutations
description: Learn how to handle form submissions and data mutations with Next.js.
org_title: Server Actions and Mutations
org_path: /docs/app/building-your-application/data-fetching/server-actions-and-mutations
is_empty: false
nav_title: Server Actions and Mutations
---

Server Actions ã¯ã€Server ä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹**éåŒæœŸé–¢æ•°**ã§ã™ã€‚ã“ã‚Œã‚‰ã¯ã€Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã®æå‡ºåŠã³ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’æ‰±ã†ãŸã‚ã«ã€server ã‚„ Client Components ã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

> **ğŸ¥ è¦–è´ã™ã‚‹:** Server Actions ã‚’ç”¨ã„ã¦ãƒ•ã‚©ãƒ¼ãƒ ã¨å¤‰ç•°ã«ã¤ã„ã¦è©³ã—ãå­¦ã³ã¾ã—ã‚‡ã† â†’ [YouTube (10 åˆ†é–“)](https://youtu.be/dDpZfOQBMaU?si=cJZHlUu_jFhCzHUg).

## Convention

Server Action ã¯ã€React ã®[`"use server"`](https://react.dev/reference/react/use-server)ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¯`async`é–¢æ•°ã®å…ˆé ­ã«é…ç½®ã—ã¦ã€ãã®é–¢æ•°ã‚’ Server Action ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ãŸã‚Šã€åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«é…ç½®ã—ã¦ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å…¨ã¦ã® export ã‚’ Server Actions ã¨ã—ã¦ãƒãƒ¼ã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### Server Components

Server Components ã¯ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é–¢æ•°ãƒ¬ãƒ™ãƒ«ã¾ãŸã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã§`"use server"`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Server Action ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã™ã‚‹ã«ã¯ã€é–¢æ•°æœ¬æ–‡ã®å…ˆé ­ã«`"use server"`ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```tsx:app/page.tsx
// Server Component
export default function Page() {
  // Server Action
  async function create() {
    'use server'

    // ...
  }

  return (
    // ...
  )
}
```

```jsx:app/page.jsx
// Server Component
export default function Page() {
  // Server Action
  async function create() {
    'use server'

    // ...
  }

  return (
    // ...
  )
}
```

### Client Components

Client Components ã¯ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã®`"use server"`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ç”¨ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã‚’ import ã§ãã¾ã™ã€‚"

Client Component å†…ã§ Server Action ã‚’å‘¼ã³å‡ºã™ã«ã¯ã€æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ãã®æœ€ä¸Šéƒ¨ã«"`"use server"`"ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’è¿½åŠ ã—ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã™ã¹ã¦ã®é–¢æ•°ã¯ Server Actions ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚Œã€Client ãŠã‚ˆã³ Server Components ã®ä¸¡æ–¹ã§å†åˆ©ç”¨ã§ãã¾ã™ã€‚

```tsx:app/actions.ts
'use server'

export async function create() {
  // ...
}
```

```js:app/actions.js
'use server'

export async function create() {
  // ...
}
```

```tsx:app/ui/button.tsx
import { create } from '@/app/actions'

export function Button() {
  return (
    // ...
  )
}
```

```jsx:app/ui/button.js
import { create } from '@/app/actions'

export function Button() {
  return (
    // ...
  )
}
```

ã¾ãŸã€ãƒ—ãƒ­ãƒƒãƒ—ã¨ã—ã¦ Server Action ã‚’ Client Component ã«æ¸¡ã™ã“ã¨ã‚‚ã§ãã¾ã™ï¼š

```jsx
<ClientComponent updateItem={updateItem} />
```

```jsx:app/client-component.jsx
'use client'

export default function ClientComponent({ updateItem }) {
  return <form action={updateItem}>{/* ... */}</form>
}
```

## Behavior

- [`<form>`è¦ç´ ](#forms)ã®`action`å±æ€§ã‚’ä½¿ç”¨ã—ã¦ã€Server actions ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚
  - Server Components ã¯ã€default ã§ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ã‚¨ãƒ³ãƒãƒ³ã‚¹ãƒ¡ãƒ³ãƒˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€JavaScript ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã‚„ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã§ã‚‚ã€ãƒ•ã‚©ãƒ¼ãƒ ãŒé€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
  - Client Components ã§ã¯ã€Server Actions ã‚’å‘¼ã³å‡ºã™ãƒ•ã‚©ãƒ¼ãƒ ã¯ã€JavaScript ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã€é€ä¿¡ã‚’ã‚­ãƒ¥ãƒ¼ã«å…¥ã‚Œã€client hydration ã‚’å„ªå…ˆã—ã¾ã™ã€‚
  - æ°´åˆ†è£œçµ¦å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚©ãƒ¼ãƒ æå‡ºæ™‚ã« refresh ã—ã¾ã›ã‚“ã€‚
- Server Actions ã¯`<form>`ã«é™å®šã•ã‚Œãšã€ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã€`useEffect`ã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ãã—ã¦`<button>`ã®ã‚ˆã†ãªä»–ã®ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‹ã‚‰å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚
- Server Actions ã¯ Next.js ã®[caching and revalidation](/ja/javascript/next.js/v14/02-app/01-building-your-application/04-caching)ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨çµ±åˆã—ã¾ã™ã€‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã€Next.js ã¯æ›´æ–°ã•ã‚ŒãŸ UI ã¨æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’å˜ä¸€ã® server ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—ã§è¿”ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
- è£å´ã§ã¯ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯`POST`method ã‚’ä½¿ç”¨ã—ã€ã“ã® HTTP method ã®ã¿ãŒãã‚Œã‚‰ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚
- Server Actions ã®å¼•æ•°ã¨æˆ»ã‚Š value ã® value ã¯ã€React ã«ã‚ˆã£ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªå¼•æ•°ã¨ value ã®ãƒªã‚¹ãƒˆã«ã¤ã„ã¦ã¯ã€[ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªå¼•æ•°ã¨ value](https://react.dev/reference/react/use-server#serializable-parameters-and-return-values)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
- Server Actions ã¯é–¢æ•°ã§ã™ã€‚ã“ã‚Œã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã©ã“ã§ã‚‚å†åˆ©ç”¨ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
- Server Actions ã¯ã€ãã‚Œã‚‰ãŒä½¿ç”¨ã•ã‚Œã‚‹ãƒšãƒ¼ã‚¸ã¾ãŸã¯ layout ã‹ã‚‰[runtime](/ja/javascript/next.js/v14/02-app/01-building-your-application/03-rendering/04-edge-and-nodejs-runtimes)ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚
- Server Actions ã¯ãƒšãƒ¼ã‚¸ã¾ãŸã¯ layout ã‹ã‚‰ã€`maxDuration`ã®ã‚ˆã†ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€[Route ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ Config](/ja/javascript/next.js/v14/02-app/02-api-reference/02-file-conventions/route-segment-config)ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚

## Examples

### Forms

React ã¯[`<form>`](https://developer.mozilla.org/docs/Web/HTML/Element/form)è¦ç´ ã‚’æ‹¡å¼µã—ã€`action`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦ Server Actions ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ•ã‚©ãƒ¼ãƒ ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯è‡ªå‹•çš„ã«[`FormData`](https://developer.mozilla.org/docs/Web/API/FormData/FormData) object ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã« React ã® `useState`ã‚’ä½¿ã†å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã®[`FormData`Method](https://developer.mozilla.org/en-US/docs/Web/API/FormData#instance_methods)ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã§ãã¾ã™ã€‚

```tsx:app/invoices/page.tsx
export default function Page() {
  async function createInvoice(formData: FormData) {
    'use server'

    const rawFormData = {
      customerId: formData.get('customerId'),
      amount: formData.get('amount'),
      status: formData.get('status'),
    }

    // mutate data
    // revalidate cache
  }

  return <form action={createInvoice}>...</form>
}
```

```jsx:app/invoices/page.jsx
export default function Page() {
  async function createInvoice(formData) {
    'use server'

    const rawFormData = {
      customerId: formData.get('customerId'),
      amount: formData.get('amount'),
      status: formData.get('status'),
    }

    // mutate data
    // revalidate cache
  }

  return <form action={createInvoice}>...</form>
}
```

> **Good to know:**
>
> - ä¾‹ï¼š[Loading & Error çŠ¶æ…‹ã‚’æŒã¤ãƒ•ã‚©ãƒ¼ãƒ ](https://github.com/vercel/next.js/tree/canary/examples/next-forms)
> - å¤šãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ“ä½œã™ã‚‹éš›ã«ã¯ã€JavaScript ã®[`Object.fromEntries()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/fromEntries)ã¨ã¨ã‚‚ã«ã€[`entries()`](https://developer.mozilla.org/en-US/docs/Web/API/FormData/entries) method ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ä¾‹ãˆã°ï¼š`const rawFormData = Object.fromEntries(formData.entries())`
> - è©³ã—ãã¯ã€[React `<form>` ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³](https://react.dev/reference/react-dom/components/form#handle-form-submission-with-a-server-action)ã‚’ã”è¦§ãã ã•ã„ã€‚

#### è¿½åŠ å¼•æ•°ã®æ¸¡ã—æ–¹

ã‚ãªãŸã¯è¿½åŠ ã®å¼•æ•°ã‚’ Server Action ã«ã€JavaScript ã® `bind` method ã‚’ä½¿ç”¨ã—ã¦æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx:app/client-component.tsx
'use client'

import { updateUser } from './actions'

export function UserProfile({ userId }: { userId: string }) {
  const updateUserWithId = updateUser.bind(null, userId)

  return (
    <form action={updateUserWithId}>
      <input type="text" name="name" />
      <button type="submit">Update User Name</button>
    </form>
  )
}
```

```jsx:app/client-component.js
'use client'

import { updateUser } from './actions'

export function UserProfile({ userId }) {
  const updateUserWithId = updateUser.bind(null, userId)

  return (
    <form action={updateUserWithId}>
      <input type="text" name="name" />
      <button type="submit">Update User Name</button>
    </form>
  )
}
```

Server Action ã¯ã€ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã«åŠ ãˆã¦ã€`userId`å¼•æ•°ã‚’å—ã‘å–ã‚Šã¾ã™ï¼š

```js:app/actions.js
'use server'

export async function updateUser(userId, formData) {
  // ...
}
```

> **Good to know**:
>
> - ä»£æ›¿æ¡ˆã¯ã€ãƒ•ã‚©ãƒ¼ãƒ å†…ã«éš ã—å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦å¼•æ•°ã‚’æ¸¡ã™ã“ã¨ã§ã™(ä¾‹ãˆã°ã€`<input type="hidden" name="userId" value={userId} />`)ã€‚ãŸã ã—ã€value ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸ HTML ã®ä¸€éƒ¨ã¨ãªã‚Šã€ã‚¨ãƒ³ Code ã•ã‚Œã¾ã›ã‚“ã€‚
> - `.bind`ã¯ã€Server ã¨ Client Components ã®ä¸¡æ–¹ã§æ©Ÿèƒ½ã—ã¾ã™ã€‚ã¾ãŸã€ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ã‚¨ãƒ³ãƒãƒ³ã‚¹ãƒ¡ãƒ³ãƒˆã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

#### ä¿ç•™ä¸­ã®çŠ¶æ…‹

ãƒ•ã‚©ãƒ¼ãƒ ãŒæå‡ºã•ã‚Œã¦ã„ã‚‹é–“ã€ä¿ç•™ä¸­ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€React ã®[`useFormStatus`](https://react.dev/reference/react-dom/hooks/useFormStatus) hook ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- `useFormStatus`ã¯ç‰¹å®šã®`<form>`ã®çŠ¶æ…‹ã‚’è¿”ã™ãŸã‚ã€**`<form>`è¦ç´ ã®å­ã¨ã—ã¦å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**
- `useFormStatus` ã¯ React hook ã§ã‚ã‚Šã€ã—ãŸãŒã£ã¦ Client Component ã®ä¸­ã§ä½¿ç”¨ã•ã‚Œãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

```tsx:app/submit-button.tsx
'use client'

import { useFormStatus } from 'react-dom'

export function SubmitButton() {
  const { pending } = useFormStatus()

  return (
    <button type="submit" aria-disabled={pending}>
      Add
    </button>
  )
}
```

```jsx:app/submit-button.jsx
'use client'

import { useFormStatus } from 'react-dom'

export function SubmitButton() {
  const { pending } = useFormStatus()

  return (
    <button type="submit" aria-disabled={pending}>
      Add
    </button>
  )
}
```

`<SubmitButton />`ã¯ãã®å¾Œã€ä»»æ„ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

```tsx:app/page.tsx
import { SubmitButton } from '@/app/submit-button'
import { createItem } from '@/app/actions'

// Server Component
export default async function Home() {
  return (
    <form action={createItem}>
      <input type="text" name="field-name" />
      <SubmitButton />
    </form>
  )
}
```

```jsx:app/page.jsx
import { SubmitButton } from '@/app/submit-button'
import { createItem } from '@/app/actions'

// Server Component
export default async function Home() {
  return (
    <form action={createItem}>
      <input type="text" name="field-name" />
      <SubmitButton />
    </form>
  )
}
```

#### Server-side ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ error ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

åŸºæœ¬çš„ãª Client ã‚µã‚¤ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã«ã¯ã€`required` ã‚„ `type="email"` ã®ã‚ˆã†ãª HTML ã®æ¤œè¨¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

ã‚ˆã‚Šé«˜åº¦ãª server-side ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«ã€ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹å‰ã«ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ã€[zod](https://zod.dev/)ã®ã‚ˆã†ãª library ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx:app/actions.ts
'use server'

import { z } from 'zod'

const schema = z.object({
  email: z.string({
    invalid_type_error: 'Invalid Email',
  }),
})

export default async function createUser(formData: FormData) {
  const validatedFields = schema.safeParse({
    email: formData.get('email'),
  })

  // Return early if the form data is invalid
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }

  // Mutate data
}
```

```jsx:app/actions.js
'use server'

import { z } from 'zod'

const schema = z.object({
  email: z.string({
    invalid_type_error: 'Invalid Email',
  }),
})

export default async function createsUser(formData) {
  const validatedFields = schema.safeParse({
    email: formData.get('email'),
  })

  // Return early if the form data is invalid
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }

  // Mutate data
}
```

ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ server ã§ç¢ºèªã•ã‚Œã‚‹ã¨ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ–ãƒ«ãª object ã‚’è¿”ã—ã€React ã®[`useFormState`](https://react.dev/reference/react-dom/hooks/useFormState)hook ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã« message ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- `useFormState`ã¸ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ¸¡ã—ã«ã‚ˆã£ã¦ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®é–¢æ•°ã®ã‚·ã‚°ãƒãƒãƒ£ã¯ã€æœ€åˆã®å¼•æ•°ã¨ã—ã¦æ–°ã—ã„`prevState`ã¾ãŸã¯`initialState`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«å¤‰ã‚ã‚Šã¾ã™ã€‚
- `useFormState`ã¯ React hook ã§ã‚ã‚Šã€ãã®ãŸã‚ã«ã¯ Client Component å†…ã§ä½¿ç”¨ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

```tsx:app/actions.ts
'use server'

export async function createUser(prevState: any, formData: FormData) {
  // ...
  return {
    message: 'Please enter a valid email',
  }
}
```

```jsx:app/actions.js
'use server'

export async function createUser(prevState, formData) {
  // ...
  return {
    message: 'Please enter a valid email',
  }
}
```

ãã®å¾Œã€`useFormState`ã® hook ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã—ã€è¿”ã•ã‚ŒãŸ`state`ã‚’ä½¿ç”¨ã—ã¦ errormessage ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx:app/ui/signup.tsx
'use client'

import { useFormState } from 'react-dom'
import { createUser } from '@/app/actions'

const initialState = {
  message: '',
}

export function Signup() {
  const [state, formAction] = useFormState(createUser, initialState)

  return (
    <form action={formAction}>
      <label htmlFor="email">Email</label>
      <input type="text" id="email" name="email" required />
      {/* ... */}
      <p aria-live="polite" className="sr-only">
        {state?.message}
      </p>
      <button>Sign up</button>
    </form>
  )
}
```

```jsx:app/ui/signup.js
'use client'

import { useFormState } from 'react-dom'
import { createUser } from '@/app/actions'

const initialState = {
  message: '',
}

export function Signup() {
  const [state, formAction] = useFormState(createUser, initialState)

  return (
    <form action={formAction}>
      <label htmlFor="email">Email</label>
      <input type="text" id="email" name="email" required />
      {/* ... */}
      <p aria-live="polite" className="sr-only">
        {state?.message}
      </p>
      <button>Sign up</button>
    </form>
  )
}
```

> **Good to know:**
>
> - ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰ç•°ã•ã›ã‚‹å‰ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ã‚‚æŒã£ã¦ã„ã‚‹ã“ã¨ã‚’å¸¸ã«ç¢ºèªã™ã‚‹ã¹ãã§ã™ã€‚[Authentication and Authorization](#authentication-and-authorization)ã‚’ã”è¦§ãã ã•ã„ã€‚

#### æ¥½è¦³çš„ãªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

ã‚ãªãŸã¯ã€React ã®[`useOptimistic`](https://react.dev/reference/react/useOptimistic) hook ã‚’ä½¿ç”¨ã—ã¦ã€Server Action ãŒçµ‚äº†ã™ã‚‹ã®ã‚’å¾…ã¤ã®ã§ã¯ãªãã€å‰å‘ãã« UI ã‚’æ›´æ–°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€response ã‚’å¾…ã¤ã®ã§ã¯ãªãã€è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx:app/page.tsx
'use client'

import { useOptimistic } from 'react'
import { send } from './actions'

type Message = {
  message: string
}

export function Thread({ messages }: { messages: Message[] }) {
  const [optimisticMessages, addOptimisticMessage] = useOptimistic<Message[]>(
    messages,
    (state: Message[], newMessage: string) => [
      ...state,
      { message: newMessage },
    ]
  )

  return (
    <div>
      {optimisticMessages.map((m, k) => (
        <div key={k}>{m.message}</div>
      ))}
      <form
        action={async (formData: FormData) => {
          const message = formData.get('message')
          addOptimisticMessage(message)
          await send(message)
        }}
      >
        <input type="text" name="message" />
        <button type="submit">Send</button>
      </form>
    </div>
  )
}
```

```jsx:app/page.jsx
'use client'

import { useOptimistic } from 'react'
import { send } from './actions'

export function Thread({ messages }) {
  const [optimisticMessages, addOptimisticMessage] = useOptimistic(
    messages,
    (state, newMessage) => [...state, { message: newMessage }]
  )

  return (
    <div>
      {optimisticMessages.map((m) => (
        <div>{m.message}</div>
      ))}
      <form
        action={async (formData) => {
          const message = formData.get('message')
          addOptimisticMessage(message)
          await send(message)
        }}
      >
        <input type="text" name="message" />
        <button type="submit">Send</button>
      </form>
    </div>
  )
}
```

#### ãƒã‚¹ãƒˆã•ã‚ŒãŸè¦ç´ 

`<form>`å†…ã«ãƒã‚¹ãƒˆã•ã‚ŒãŸè¦ç´ ã€ä¾‹ãˆã°`<button>`ã€`<input type="submit">`ã€`<input type="image">`ãªã©ã§ã€Server Action ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã®è¦ç´ ã¯`formAction`ãƒ—ãƒ­ãƒƒãƒ—ã¾ãŸã¯[event handlers](#event-handlers)ã‚’å—ã‘å…¥ã‚Œã¾ã™ã€‚

ã“ã‚Œã¯ã€ãƒ•ã‚©ãƒ¼ãƒ å†…ã§è¤‡æ•°ã® server actions ã‚’å‘¼ã³å‡ºã—ãŸã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚ä¾‹ãˆã°ã€ãã‚Œã‚’å…¬é–‹ã™ã‚‹ä»–ã« post ã®ãƒ‰ãƒ©ãƒ•ãƒˆã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ç‰¹å®šã®`<button>`è¦ç´ ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è©³ã—ãã¯ã€[React ã®`<form>`ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://react.dev/reference/react-dom/components/form#handling-multiple-submission-types)ã‚’ã”è¦§ãã ã•ã„ã€‚

#### ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯ãªãƒ•ã‚©ãƒ¼ãƒ ã®æå‡º

[`requestSubmit()`](https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/requestSubmit) method ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã‚’ãƒˆãƒªã‚¬ãƒ¼ã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ`âŒ˜` + `Enter`ã‚’æŠ¼ã—ãŸã¨ãã€`onKeyDown`ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³ã§ãã¾ã™ï¼š

```tsx:app/entry.tsx
'use client'

export function Entry() {
  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (
      (e.ctrlKey || e.metaKey) &&
      (e.key === 'Enter' || e.key === 'NumpadEnter')
    ) {
      e.preventDefault()
      e.currentTarget.form?.requestSubmit()
    }
  }

  return (
    <div>
      <textarea name="entry" rows={20} required onKeyDown={handleKeyDown} />
    </div>
  )
}
```

```jsx:app/entry.jsx
'use client'

export function Entry() {
  const handleKeyDown = (e) => {
    if (
      (e.ctrlKey || e.metaKey) &&
      (e.key === 'Enter' || e.key === 'NumpadEnter')
    ) {
      e.preventDefault()
      e.currentTarget.form?.requestSubmit()
    }
  }

  return (
    <div>
      <textarea name="entry" rows={20} required onKeyDown={handleKeyDown} />
    </div>
  )
}
```

ã“ã‚Œã«ã‚ˆã‚Šã€æœ€ã‚‚è¿‘ã„`<form>`ã®ç¥–å…ˆã®æå‡ºãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã€Server Action ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

### éãƒ•ã‚©ãƒ¼ãƒ è¦ç´ 

`<form>` è¦ç´ å†…ã§ Server Actions ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ãŒã€ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚„ `useEffect` ãªã©ã€code ã®ä»–ã®éƒ¨åˆ†ã‹ã‚‰ã‚‚å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

#### ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼

`onClick`ã®ã‚ˆã†ãªã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‹ã‚‰ Server Action ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ã„ã„ã­ã®æ•°ã‚’å¢—ã‚„ã™ãŸã‚ã«ï¼š

```tsx:app/like-button.tsx
'use client'

import { incrementLike } from './actions'
import { useState } from 'react'

export default function LikeButton({ initialLikes }: { initialLikes: number }) {
  const [likes, setLikes] = useState(initialLikes)

  return (
    <>
      <p>Total Likes: {likes}</p>
      <button
        onClick={async () => {
          const updatedLikes = await incrementLike()
          setLikes(updatedLikes)
        }}
      >
        Like
      </button>
    </>
  )
}
```

```jsx:app/like-button.js
'use client'

import { incrementLike } from './actions'
import { useState } from 'react'

export default function LikeButton({ initialLikes }) {
  const [likes, setLikes] = useState(initialLikes)

  return (
    <>
      <p>Total Likes: {likes}</p>
      <button
        onClick={async () => {
          const updatedLikes = await incrementLike()
          setLikes(updatedLikes)
        }}
      >
        Like
      </button>
    </>
  )
}
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã€ä»–ã® React APIã€[`useOptimistic`](https://react.dev/reference/react/useOptimistic) ã‚„ [`useTransition`](https://react.dev/reference/react/useTransition) ãªã©ã‚’ä½¿ç”¨ã—ã¦ã€Server Action ãŒ server ä¸Šã§å®Ÿè¡Œã‚’çµ‚ãˆã‚‹å‰ã« UI ã‚’æ›´æ–°ã—ãŸã‚Šã€ä¿ç•™çŠ¶æ…‹ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

ã¾ãŸã€ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’`onChange`ã§ä¿å­˜ã™ã‚‹ãªã©ã§ã™ã€‚

```tsx:app/ui/edit-post.tsx
'use client'

import { publishPost, saveDraft } from './actions'

export default function EditPost() {
  return (
    <form action={publishPost}>
      <textarea
        name="content"
        onChange={async (e) => {
          await saveDraft(e.target.value)
        }}
      />
      <button type="submit">Publish</button>
    </form>
  )
}
```

ã“ã®ã‚ˆã†ãªå ´åˆã€è¤‡æ•°ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒçŸ­æœŸé–“ã§ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ä¸è¦ãª Server Action ã®å‘¼ã³å‡ºã—ã‚’é˜²ããŸã‚ã«ã€**debouncing**ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

#### `useEffect`

ã‚ãªãŸã¯ã€ React [`useEffect`](https://react.dev/reference/react/useEffect) hook ã‚’ä½¿ç”¨ã—ã¦ã€ component ãŒãƒã‚¦ãƒ³ãƒˆã¾ãŸã¯ä¾å­˜é–¢ä¿‚ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã« Server Action ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚¤ãƒ™ãƒ³ãƒˆã«ä¾å­˜ã™ã‚‹å¤‰ç•°ã‚„ã€è‡ªå‹•çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚ä¾‹ãˆã°ã€ app ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨ã® `onKeyDown` ã€ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ã®äº¤å·®è¦³æ¸¬è€… hook ã€ã¾ãŸã¯ component ãŒãƒã‚¦ãƒ³ãƒˆã—ã¦ãƒ“ãƒ¥ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹å ´åˆãªã©ã§ã™ã€‚

```tsx:app/view-count.tsx
'use client'

import { incrementViews } from './actions'
import { useState, useEffect } from 'react'

export default function ViewCount({ initialViews }: { initialViews: number }) {
  const [views, setViews] = useState(initialViews)

  useEffect(() => {
    const updateViews = async () => {
      const updatedViews = await incrementViews()
      setViews(updatedViews)
    }

    updateViews()
  }, [])

  return <p>Total Views: {views}</p>
}
```

```jsx:app/view-count.js
'use client'

import { incrementViews } from './actions'
import { useState, useEffect } from 'react'

export default function ViewCount({ initialViews }: { initialViews: number }) {
  const [views, setViews] = useState(initialViews)

  useEffect(() => {
    const updateViews = async () => {
      const updatedViews = await incrementViews()
      setViews(updatedViews)
    }

    updateViews()
  }, [])

  return <p>Total Views: {views}</p>
}
```

`useEffect`ã®[æŒ¯ã‚‹èˆã„ã¨æ³¨æ„ç‚¹](https://react.dev/reference/react/useEffect#caveats)ã‚’è€ƒæ…®ã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚

### Error ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

error ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹ã¨ã€ãã‚Œã¯æœ€ã‚‚è¿‘ã„[`error.js`](/ja/javascript/next.js/v14/02-app/01-building-your-application/01-routing/05-error-handling)ã¾ãŸã¯`<Suspense>`ã®å¢ƒç•Œã§ client ã«ã‚ˆã£ã¦ã‚­ãƒ£ãƒƒãƒã•ã‚Œã¾ã™ã€‚æˆ‘ã€…ã¯`try/catch`ã‚’ä½¿ç”¨ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ UI ã§å‡¦ç†ã™ã‚‹ã‚ˆã†ã«è¿”ã™ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ã‚ãªãŸã® Server Action ã¯æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã®ä½œæˆã‹ã‚‰ã® error ã‚’å‡¦ç†ã—ã€message ã‚’è¿”ã™ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```ts:app/actions.ts
'use server'

export async function createTodo(prevState: any, formData: FormData) {
  try {
    // Mutate data
  } catch (e) {
    throw new Error('Failed to create task')
  }
}
```

```js:app/actions.js
'use server'

export async function createTodo(prevState, formData) {
  try {
    //  Mutate data
  } catch (e) {
    throw new Error('Failed to create task')
  }
}
```

> **Good to know:**
>
> - error ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ä»¥å¤–ã«ã‚‚ã€`useFormState`ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã‚‹ object ã‚’è¿”ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚[Server-side validation and error handling](#server-side-validation-and-error-handling)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### ãƒ‡ãƒ¼ã‚¿ã®å†æ¤œè¨¼

ã‚ãªãŸã¯ã€Server Actions å†…ã§ [`revalidatePath`](/ja/javascript/next.js/v14/02-app/02-api-reference/04-functions/revalidatePath) API ã‚’ä½¿ç”¨ã—ã¦ã€[Next.js Cache](/ja/javascript/next.js/v14/02-app/01-building-your-application/04-caching)ã‚’ revalidate ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts:app/actions.ts
'use server'

import { revalidatePath } from 'next/cache'

export async function createPost() {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidatePath('/posts')
}
```

```js:app/actions.js
'use server'

import { revalidatePath } from 'next/cache'

export async function createPost() {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidatePath('/posts')
}
```

ã¾ãŸã¯ã€[`revalidateTag`](/ja/javascript/next.js/v14/02-app/02-api-reference/04-functions/revalidateTag)ã‚’ä½¿ç”¨ã—ã¦ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ fetch ã‚’ cache ã‚¿ã‚°ã§ç„¡åŠ¹ã«ã—ã¾ã™ï¼š

```ts:app/actions.ts
'use server'

import { revalidateTag } from 'next/cache'

export async function createPost() {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidateTag('posts')
}
```

```js:app/actions.js
'use server'

import { revalidateTag } from 'next/cache'

export async function createPost() {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidateTag('posts')
}
```

### Redirecting

Server Action ã®å®Œäº†å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¥ã® route ã« redirect ã—ãŸã„å ´åˆã¯ã€[`redirect`](/ja/javascript/next.js/v14/02-app/02-api-reference/04-functions/redirect) API ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚`redirect`ã¯`try/catch`ãƒ–ãƒ­ãƒƒã‚¯ã®å¤–éƒ¨ã§å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```ts:app/actions.ts
'use server'

import { redirect } from 'next/navigation'
import { revalidateTag } from 'next/cache'

export async function createPost(id: string) {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidateTag('posts') // Update cached posts
  redirect(`/post/${id}`) // Navigate to the new post page
}
```

```js:app/actions.js
'use server'

import { redirect } from 'next/navigation'
import { revalidateTag } from 'next/cache'

export async function createPost(id) {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidateTag('posts') // Update cached posts
  redirect(`/post/${id}`) // Navigate to the new post page
}
```

### Cookies

`get`ã€`set`ã€ãã—ã¦`delete`ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã€ Server Action ã®ä¸­ã§ cookies ã‚’æ“ä½œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã¯[`cookies`](/ja/javascript/next.js/v14/02-app/02-api-reference/04-functions/cookies) API ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```ts:app/actions.ts
'use server'

import { cookies } from 'next/headers'

export async function exampleAction() {
  // Get cookie
  const value = cookies().get('name')?.value

  // Set cookie
  cookies().set('name', 'Delba')

  // Delete cookie
  cookies().delete('name')
}
```

```js:app/actions.js
'use server'

import { cookies } from 'next/headers'

export async function exampleAction() {
  // Get cookie
  const value = cookies().get('name')?.value

  // Set cookie
  cookies().set('name', 'Delba')

  // Delete cookie
  cookies().delete('name')
}
```

Server Actions ã‹ã‚‰ã® cookies ã®å‰Šé™¤ã«ã¤ã„ã¦ã€[è¿½åŠ ã®ä¾‹](/ja/javascript/next.js/v14/02-app/02-api-reference/04-functions/cookies#deleting-cookies)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## Security

### èªè¨¼ã¨æ‰¿èª

ã‚ãªãŸã¯ã€Server Actions ã‚’å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨åŒã˜ã‚ˆã†ã«æ‰±ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®èªè¨¼ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã¹ãã§ã™ã€‚ä¾‹ãˆã°:

```tsx:app/actions.ts
'use server'

import { auth } from './lib'

export function addItem() {
  const { user } = auth()
  if (!user) {
    throw new Error('You must be signed in to perform this action')
  }

  // ...
}
```

### ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã¨æš—å·åŒ–

component å†…ã§ Server Action ã‚’å®šç¾©ã™ã‚‹ã¨ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¤–éƒ¨é–¢æ•°ã® scope ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹[closure](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures)ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ ä¾‹ãˆã°ã€`publish`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯`publishVersion` variable ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

```tsx:app/page.tsx
export default function Page() {
  const publishVersion = await getLatestVersion();

  async function publish(formData: FormData) {
    "use server";
    if (publishVersion !== await getLatestVersion()) {
      throw new Error('The version has changed since pressing publish');
    }
    ...
  }

  return <button action={publish}>Publish</button>;
}
```

```jsx:app/page.js
export default function Page() {
  const publishVersion = await getLatestVersion();

  async function publish() {
    "use server";
    if (publishVersion !== await getLatestVersion()) {
      throw new Error('The version has changed since pressing publish');
    }
    ...
  }

  return <button action={publish}>Publish</button>;
}
```

Closures ã¯ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã®ãƒ‡ãƒ¼ã‚¿(ä¾‹ï¼š`publishVersion`)ã®*ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ*ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ã€å¾Œã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã«å½¹ç«‹ã¡ã¾ã™ã€‚

ã—ã‹ã—ã€ã“ã‚ŒãŒèµ·ã“ã‚‹ãŸã‚ã«ã¯ã€ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸ variables ãŒ client ã«é€ä¿¡ã•ã‚Œã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ãã« server ã«æˆ»ã•ã‚Œã¾ã™ã€‚æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ãŒ client ã«éœ²å‡ºã™ã‚‹ã®ã‚’é˜²ããŸã‚ã«ã€ Next.js ã¯è‡ªå‹•çš„ã«é–‰ã˜è¾¼ã‚ã‚‰ã‚ŒãŸ variables ã‚’æš—å·åŒ–ã—ã¾ã™ã€‚æ–°ã—ã„ç§˜å¯†éµãŒ Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒ build ã•ã‚Œã‚‹ãŸã³ã«ã€ãã‚Œãã‚Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç‰¹å®šã® build ã«å¯¾ã—ã¦ã®ã¿å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

> **Good to knowï¼š** ç§ãŸã¡ã¯ã€æš—å·åŒ–ã ã‘ã«é ¼ã£ã¦ client ä¸Šã§æ©Ÿå¯†å€¤ãŒéœ²å‡ºã™ã‚‹ã®ã‚’é˜²ãã“ã¨ã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ã€[React taint API](/ja/javascript/next.js/v14/02-app/01-building-your-application/02-data-fetching/03-patterns#preventing-sensitive-data-from-being-exposed-to-the-client)ã‚’ä½¿ç”¨ã—ã¦ã€ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ãŒ client ã«é€ä¿¡ã•ã‚Œã‚‹ã®ã‚’ç©æ¥µçš„ã«é˜²ãã¹ãã§ã™ã€‚

### æš—å·åŒ–ã‚­ãƒ¼ã®ä¸Šæ›¸ã(ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ‰)

ã‚ãªãŸã® Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ã§ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã¨ãã€å„ server ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ç•°ãªã‚‹æš—å·åŒ–ã‚­ãƒ¼ã‚’æŒã¤å¯èƒ½æ€§ãŒã‚ã‚Šã€ã“ã‚ŒãŒæ½œåœ¨çš„ãªä¸æ•´åˆã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’ç·©å’Œã™ã‚‹ãŸã‚ã«ã¯ã€`process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY` ç’°å¢ƒ variable ã‚’ä¸Šæ›¸ãã—ã¦æš—å·åŒ–ã‚­ãƒ¼ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ã“ã® variable ã‚’æŒ‡å®šã™ã‚‹ã¨ã€æš—å·åŒ–ã‚­ãƒ¼ãŒ build é–“ã§æŒç¶šã—ã€ã™ã¹ã¦ã® server ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåŒã˜ã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¨ã£ã¦è¤‡æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå…¨ä½“ã§ä¸€è²«ã—ãŸæš—å·åŒ–å‹•ä½œãŒé‡è¦ãªé«˜åº¦ãªä½¿ç”¨ã‚±ãƒ¼ã‚¹ã§ã™ã€‚ã‚­ãƒ¼ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ç½²åãªã©ã®æ¨™æº–çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’æ¤œè¨ã™ã‚‹ã¹ãã§ã™ã€‚

> **Good to knowï¼š** Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ Vercel ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨è‡ªå‹•çš„ã«ã“ã‚Œã‚’å‡¦ç†ã—ã¾ã™ã€‚

### è¨±å¯ã•ã‚ŒãŸèµ·æº (ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ‰)

Server Actions ã¯`<form>`è¦ç´ ã§å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€ãã‚Œã‚‰ã¯[CSRF æ”»æ’ƒ](https://developer.mozilla.org/en-US/docs/Glossary/CSRF)ã‚’å—ã‘ã‚„ã™ããªã‚Šã¾ã™ã€‚

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã¯ã€Server Actions ãŒ`POST`method ã‚’ä½¿ç”¨ã—ã€ã“ã® HTTP method ã ã‘ãŒãã‚Œã‚‰ã‚’å‘¼ã³å‡ºã™ã“ã¨ã‚’è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç¾ä»£ã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã«ãŠã‘ã‚‹ã»ã¨ã‚“ã©ã® CSRF ã®è„†å¼±æ€§ãŒé˜²æ­¢ã•ã‚Œã€ç‰¹ã«[SameSitecookies](https://web.dev/articles/samesite-cookies-explained)ãŒ default ã¨ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

è¿½åŠ ã®ä¿è­·ã¨ã—ã¦ã€Next.js ã® Server Actions ã¯ã€[Origin header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Origin)ã‚’[Host header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host)(ã¾ãŸã¯`X-Forwarded-Host`)ã¨æ¯”è¼ƒã—ã¾ã™ã€‚ã“ã‚Œã‚‰ãŒä¸€è‡´ã—ãªã„å ´åˆã€request ã¯ä¸­æ­¢ã•ã‚Œã¾ã™ã€‚è¨€ã„æ›ãˆã‚Œã°ã€Server Actions ã¯ãã‚Œã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹ãƒšãƒ¼ã‚¸ã¨åŒã˜ host ã§ã®ã¿èµ·å‹•ã§ãã¾ã™ã€‚

å¤§è¦æ¨¡ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚„ãƒãƒ«ãƒãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£(server API ãŒ production ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ç•°ãªã‚‹å ´åˆ)ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€å®‰å…¨ãªã‚ªãƒªã‚¸ãƒ³ã®ãƒªã‚¹ãƒˆã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã«ã€è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³[`serverActions.allowedOrigins`](/ja/javascript/next.js/v14/02-app/02-api-reference/05-next-config-js/serverActions)ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æ–‡å­—åˆ—ã®é…åˆ—ã‚’å—ã‘å…¥ã‚Œã¾ã™ã€‚

```js:next.config.js
/** @type {import('next').NextConfig} */
module.exports = {
  experimental: {
    serverActions: {
      allowedOrigins: ['my-proxy.com', '*.my-proxy.com'],
    },
  },
}
```

[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ Server Actions](https://nextjs.org/blog/security-nextjs-server-components-actions)ã«ã¤ã„ã¦ã‚‚ã£ã¨å­¦ã³ã¾ã—ã‚‡ã†ã€‚

## Additional resources

Server Actions ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯ã€ä»¥ä¸‹ã® React ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”è¦§ãã ã•ã„ï¼š

- "[`"use server"`](https://react.dev/reference/react/use-server)"ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
- [`<form>`](https://react.dev/reference/react-dom/components/form)
- [`useFormStatus`](https://react.dev/reference/react-dom/hooks/useFormStatus)
- [`useFormState`](https://react.dev/reference/react-dom/hooks/useFormState)
- [`useOptimistic`](https://react.dev/reference/react/useOptimistic)
